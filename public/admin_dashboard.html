<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 25px; }
    .card { display: inline-block; border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin: 8px; }
    form { margin-top: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 6px; width: 350px; display: inline-block; vertical-align: top; }
    input { display: block; width: 100%; margin-bottom: 8px; padding: 6px; }
    button { padding: 6px 12px; margin-top: 4px; }
    .logout-btn { float: right; }
    .status { margin-top: 10px; color: #006400; }
    .error { color: #b22222; }
    h3 { margin-top: 0; }
  </style>

</head>
<body>
  <h2>Admin Dashboard</h2>
  <button class="logout-btn">Logout</button>
  <p>Welcome, <span id="adminName"></span></p>

  <div id="statsContainer">
    <div class="card">
      <h3 id="studentCount">0</h3><p>Students</p>
    </div>
    <div class="card">
      <h3 id="teacherCount">0</h3><p>Teachers</p>
    </div>
    <div class="card">
      <h3 id="moduleCount">0</h3><p>Modules</p>
    </div>
    <div class="card">
      <h3 id="sessionCount">0</h3><p>Sessions</p>
    </div>
  </div>

  <form id="create-teacher">
    <h3>Create Teacher Account</h3>
    <input type="text" id="teacherFullName" placeholder="Full Name" required>
    <input type="email" id="teacherEmail" placeholder="Email" required>
    <input type="password" id="teacherPassword" placeholder="Password" required>
    <button id="createTeacherBtn" type="button">Create Teacher</button>
    <p id="teacherMsg" class="status"></p>
  </form>

  <form id="create-student">
    <h3>Create Student Account</h3>
    <input type="text" id="studentFullName" placeholder="Full Name" required>
    <input type="password" id="studentPassword" placeholder="Password" required>
    <button id="createStudentBtn" type="button">Create Student</button>
    <p id="studentMsg" class="status"></p>
  </form>

  <div id="teacherList">
    <h3>All Teachers</h3>
    <table border="1">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Matricule</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="teacherRows"></tbody>
    </table>
  </div>

  <div id="studentsList">
    <h3>All Students</h3>
    <table border="1">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Matricule</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="studentRows"></tbody>
    </table>
</div>

<script>
$(document).ready(function () {

  // SESSION CHECK
  $.get('/api/auth/check_session.php', function (res) {
    if (!res.logged_in || res.role !== 'admin') {
      window.location.href = 'login.html';
    } else {
      $('#adminName').text(res.full_name);
      loadDashboardStats();
      loadTeachers();
      loadStudents();
    }
  });

  // LOGOUT
  $('.logout-btn').click(function () {
    $.get('/api/auth/logout.php', function () {
      window.location.href = 'login.html';
    });
  });

  // DASHBOARD STATS
  function loadDashboardStats() {
    $.get('/api/admin/dashboard_data.php', function (res) {
      if (res.success) {
        $('#studentCount').text(res.stats.students);
        $('#teacherCount').text(res.stats.teachers);
        $('#moduleCount').text(res.stats.modules);
        $('#sessionCount').text(res.stats.sessions);
      } else {
        console.error('Error loading stats:', res.message);
      }
    });
  }

  // CREATE TEACHER
  $('#createTeacherBtn').click(function () {
    const payload = {
      full_name: $('#teacherFullName').val().trim(),
      email: $('#teacherEmail').val().trim(),
      password: $('#teacherPassword').val().trim(),
    };

    if (!payload.full_name || !payload.email || !payload.password) {
      $('#teacherMsg').addClass('error').text('All fields are required.');
      return;
    }

    $.ajax({
      url: '/api/admin/users/create_teacher.php',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(payload),
      success: function (res) {
        if (res.success) {
          $('#teacherMsg')
            .removeClass('error')
            .addClass('status')
            .text('✅ ' + res.message + ' Matricule: ' + res.teacher.matricule);
          $('#teacherFullName, #teacherEmail, #teacherPassword').val('');
          loadDashboardStats();
          loadTeachers();
        } else {
          $('#teacherMsg')
            .removeClass('status')
            .addClass('error')
            .text('❌ ' + res.message);
        }
      },
      error: function () {
        $('#teacherMsg')
          .removeClass('status')
          .addClass('error')
          .text('Server connection failed.');
      },
    });
  });

  // CREATE STUDENT
  $('#createStudentBtn').click(function () {
    const payload = {
      full_name: $('#studentFullName').val().trim(),
      password: $('#studentPassword').val().trim(),
    };

    if (!payload.full_name || !payload.password) {
      $('#studentMsg').addClass('error').text('All fields are required.');
      return;
    }

    $.ajax({
      url: '/api/admin/users/create_student.php',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(payload),
      success: function (res) {
        if (res.success) {
          $('#studentMsg')
            .removeClass('error')
            .addClass('status')
            .text('✅ ' + res.message + ' Matricule: ' + res.student.matricule);
          $('#studentFullName, #studentPassword').val('');
          loadDashboardStats();
          loadStudents();
        } else {
          $('#studentMsg')
            .removeClass('status')
            .addClass('error')
            .text('❌ ' + res.message);
        }
      },
      error: function () {
        $('#studentMsg')
          .removeClass('status')
          .addClass('error')
          .text('Server connection failed.');
      },
    });
  });

  // LOAD TEACHERS
  function loadTeachers() {
    $.get('/api/admin/users/get_all_teachers.php', function (res) {
      if (res.success) {
        const rows = res.teachers
          .map(
            (t) => `
          <tr>
            <td>${t.teacher_id}</td>
            <td>${t.full_name}</td>
            <td>${t.email || '-'}</td>
            <td>${t.matricule}</td>
            <td>
              <button class="edit-btn" data-id="${t.user_id}" data-name="${t.full_name}" data-email="${t.email || ''}">Edit</button>
              <button class="delete-btn" data-id="${t.user_id}">Delete</button>
            </td>
          </tr>`
          )
          .join('');
        $('#teacherRows').html(rows);
      } else {
        $('#teacherRows').html(
          '<tr><td colspan="5">Error loading teachers.</td></tr>'
        );
      }
    });
  }

  // LOAD STUDENTS
  function loadStudents() {
    $.get('/api/admin/users/get_all_students.php', function (res) {
      if (res.success) {
        const rows = res.students
          .map(
            (s) => `
          <tr>
            <td>${s.student_id}</td>
            <td>${s.full_name}</td>
            <td>${s.matricule}</td>
            <td>
              <button class="edit-btn" data-id="${s.user_id}" data-name="${s.full_name}" data-email="${s.email || ''}">Edit</button>
              <button class="delete-btn" data-id="${s.user_id}">Delete</button>
            </td>
          </tr>`
          )
          .join('');
        $('#studentRows').html(rows);
      } else {
        $('#studentRows').html(
          '<tr><td colspan="5">Error loading students.</td></tr>'
        );
      }
    });
  }

  // EDIT + DELETE HANDLERS (delegated)
  $(document).on('click', '.edit-btn', function () {
    const id = $(this).data('id');
    const name = $(this).data('name');
    const email = $(this).data('email');
    const newName = prompt('New name:', name);
    const newEmail = prompt('New email:', email);
    if (!newName || !newEmail) return;
    const newPassword = prompt('New password (leave blank to keep current):', '');

    $.ajax({
      url: '/api/admin/users/update_user.php',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        user_id: id,
        full_name: newName,
        email: newEmail,
        password: newPassword,
      }),
      success: function (res) {
        alert(res.message);
        loadTeachers();
        loadStudents();
      },
    });
  });

  $(document).on('click', '.delete-btn', function () {
    const id = $(this).data('id');
    if (!confirm('Delete this user?')) return;
    $.ajax({
      url: '/api/admin/users/delete_user.php',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ user_id: id }),
      success: function (res) {
        alert(res.message);
        loadTeachers();
        loadStudents();
      },
    });
  });
});
</script>
</body>
</html>
